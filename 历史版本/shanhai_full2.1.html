<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±±æµ·å¯»çµ | Dyæœç«‹æ­£</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== 0. æ ¸å¿ƒå˜é‡ä¸é‡ç½® ==================== */
        :root {
            --primary: #2c2520;      /* æ·±å¢¨è‰² */
            --accent: #d4af37;       /* éé‡‘è‰² */
            --accent-glow: #f9d86e;  /* é‡‘å…‰ */
            --bg-paper: #f4f1ea;     /* å®£çº¸ç™½ */
            --text-main: #2c3e50;
            --glass: rgba(255, 255, 255, 0.7);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Noto Serif SC', "Microsoft YaHei", serif;
            background: var(--bg-paper);
            color: var(--text-main);
            overflow: hidden; 
        }

        /* èƒŒæ™¯åŠ¨æ€ç²’å­ç”»å¸ƒ */
        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none; opacity: 0.6;
        }

        /* ==================== 1. å‰ç½®å¼€åœºåŠ¨ç”» ==================== */
        #intro-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a;
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
        }
        
        .loader-circle {
            width: 80px; height: 80px; border: 2px solid rgba(212, 175, 55, 0.3);
            border-top: 2px solid var(--accent); border-radius: 50%;
            animation: spin 1.5s linear infinite;
            position: relative;
        }
        
        .loader-circle::before {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px solid rgba(212, 175, 55, 0.3); border-bottom: 2px solid var(--accent);
            border-radius: 50%; animation: spin 2s linear infinite reverse;
        }

        .loader-text {
            margin-top: 20px; font-size: 24px; color: var(--accent); letter-spacing: 5px;
            opacity: 0; animation: fadeInUp 1s ease forwards 0.5s; font-weight: bold;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ==================== 2. å¯¼èˆªæ  ==================== */
        .navbar {
            height: 70px; width: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; padding: 0 30px;
            position: absolute; top: 0; z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        .logo {
            font-size: 22px; color: var(--primary); font-weight: bold; margin-right: 50px;
            display: flex; align-items: center; gap: 10px;
        }
        .logo i { color: var(--accent); font-size: 26px; filter: drop-shadow(0 0 5px var(--accent-glow)); }

        .nav-items { display: flex; gap: 10px; }
        .nav-btn {
            background: transparent; border: none; padding: 10px 20px;
            font-family: inherit; font-size: 16px; color: #666; cursor: pointer;
            border-radius: 30px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        
        .nav-btn:hover { color: var(--primary); background: rgba(212, 175, 55, 0.1); }
        .nav-btn.active { color: #fff; background: var(--primary); box-shadow: 0 4px 15px rgba(44, 37, 32, 0.3); }

        /* ==================== 3. ä¸»å†…å®¹åŒºåŸŸ ==================== */
        .main-container {
            padding-top: 70px; height: 100%; width: 100%; position: relative;
        }

        .view-section {
            display: none; height: 100%; width: 100%; overflow-y: auto; overflow-x: hidden;
            padding: 30px; scroll-behavior: smooth;
        }
        
        .view-section.active { display: block; animation: slideIn 0.6s cubic-bezier(0.25, 0.8, 0.25, 1); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .search-container {
            max-width: 1200px; margin: 0 auto 30px auto; display: flex; gap: 15px;
            position: sticky; top: 0; z-index: 50; padding: 10px 0;
        }
        
        .glass-input {
            flex: 1; padding: 15px 25px; border: 1px solid rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.6); backdrop-filter: blur(5px);
            border-radius: 50px; font-size: 16px; color: var(--primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .glass-input:focus {
            background: #fff; border-color: var(--accent); box-shadow: 0 4px 20px rgba(212, 175, 55, 0.2);
        }
        
        .glass-select {
            padding: 0 25px; border-radius: 50px; border: none; background: #fff;
            color: var(--primary); font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* ==================== 4. å›¾é‰´å¡ç‰‡ ==================== */
        .grid-layout {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px;
            max-width: 1200px; margin: 0 auto; padding-bottom: 50px;
        }

        .spirit-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; cursor: pointer;
        }

        .spirit-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            background: #fff;
        }

        .card-badge {
            position: absolute; top: 15px; right: 15px;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 14px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 2;
        }

        .card-img-placeholder {
            height: 140px; background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 50px; color: rgba(0,0,0,0.1); transition: 0.5s;
        }
        .spirit-card:hover .card-img-placeholder { color: var(--accent); transform: scale(1.05); }

        .card-content { padding: 20px; }
        .card-title { font-size: 20px; font-weight: bold; margin-bottom: 8px; color: var(--primary); display: flex; align-items: baseline; justify-content: space-between;}
        .card-id { font-size: 12px; color: #999; font-family: sans-serif; }
        .card-desc { font-size: 13px; color: #666; line-height: 1.6; margin-bottom: 15px; height: 42px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        .tag-group { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag {
            font-size: 11px; padding: 4px 10px; border-radius: 12px;
            background: rgba(0,0,0,0.03); color: #555; border: 1px solid rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .spirit-card:hover .tag { background: var(--accent); color: #fff; border-color: var(--accent); }

        .el-fire { background: linear-gradient(45deg, #ff9a9e, #ff6a00); }
        .el-water { background: linear-gradient(45deg, #a1c4fd, #1890ff); }
        .el-wood { background: linear-gradient(45deg, #d4fc79, #96e6a1); color: #2e7d32; }
        .el-metal { background: linear-gradient(45deg, #f6d365, #fda085); }
        .el-earth { background: linear-gradient(45deg, #e0c3fc, #8ec5fc); }
        .el-none { background: #ccc; }

        /* ==================== 5. å·¥åŠåˆ—è¡¨ ==================== */
        .recipe-list { max-width: 1000px; margin: 0 auto; }
        .recipe-card {
            display: flex; align-items: center; padding: 20px; margin-bottom: 15px;
            background: #fff; border-radius: 12px; box-shadow: var(--card-shadow);
            border-left: 5px solid var(--accent); opacity: 0;
            transform: translateX(-20px);
            animation: slideRight 0.5s forwards;
        }
        .recipe-card:hover { transform: scale(1.01) translateX(0); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        @keyframes slideRight { to { opacity: 1; transform: translateX(0); } }

        /* ==================== 6. é…ç§æ¨¡æ‹Ÿå™¨ ==================== */
        .breed-stage {
            max-width: 900px; margin: 50px auto; padding: 40px;
            background: rgba(255,255,255,0.9); border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); text-align: center;
            position: relative; overflow: hidden;
        }
        .breed-stage::before {
            content: ''; position: absolute; top: -50px; left: -50px; width: 150px; height: 150px;
            background: var(--accent); opacity: 0.1; border-radius: 50%;
        }
        .calc-row { display: flex; align-items: center; justify-content: center; gap: 30px; margin-top: 30px; }
        .calc-select {
            padding: 15px 30px; font-size: 18px; border: 2px solid #eee; border-radius: 12px;
            background: #fff; color: var(--primary); cursor: pointer; transition: 0.3s;
            appearance: none; text-align: center; min-width: 200px;
        }
        .calc-select:hover { border-color: var(--accent); }
        .icon-plus, .icon-eq { font-size: 30px; color: #ddd; }
        .result-egg {
            width: 120px; height: 120px; background: #fffbf0; border: 3px dashed var(--accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: var(--accent); animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* ==================== 7. åœ°å›¾ä¸æ–°æ¨¡æ€æ¡† (Map & Modal) ==================== */
        .map-wrapper { position: relative; width: 100%; height: 100%; }
        
        .map-layer-control {
            position: absolute; bottom: 30px; left: 30px; z-index: 500;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; gap: 8px; min-width: 160px;
        }
        .layer-toggle {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            padding: 8px 12px; border-radius: 8px; transition: 0.2s; user-select: none; font-size: 14px;
        }
        .layer-toggle:hover { background: rgba(0,0,0,0.05); }
        .layer-toggle.active { background: rgba(212, 175, 55, 0.15); font-weight: bold; color: var(--primary); }
        
        /* Modal Overlay */
        #marker-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 2000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #marker-modal-overlay.open { display: flex; opacity: 1; }

        .modal-card {
            width: 400px; max-width: 90%; 
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.6);
            transform: scale(0.8) translateY(20px);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        #marker-modal-overlay.open .modal-card { transform: scale(1) translateY(0); }

        .modal-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, var(--primary), #4a3f35);
            color: #fff;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 18px; font-weight: bold; letter-spacing: 1px; }
        .modal-close { cursor: pointer; font-size: 20px; opacity: 0.7; transition: 0.2s; }
        .modal-close:hover { opacity: 1; transform: rotate(90deg); }

        .modal-body { padding: 25px; max-height: 80vh; overflow-y: auto; }

        .upload-area {
            width: 100%; height: 180px;
            background: #f8f8f8; border: 2px dashed #ddd; border-radius: 12px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin-bottom: 20px; cursor: pointer; overflow: hidden; position: relative;
            transition: border-color 0.3s, background 0.3s;
        }
        .upload-area:hover { border-color: var(--accent); background: #fffcf0; }
        .upload-icon { font-size: 40px; color: #ccc; margin-bottom: 10px; transition: 0.3s; }
        .upload-text { font-size: 14px; color: #999; }
        .upload-preview { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; display: none; z-index: 5; }
        .upload-area:hover .upload-icon { color: var(--accent); transform: scale(1.1); }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; font-weight: bold; color: #888; margin-bottom: 6px; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 12px 15px; border: 1px solid #eee; background: #fff;
            border-radius: 8px; font-family: inherit; font-size: 14px; color: #333; transition: 0.3s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1); }
        .form-textarea { height: 80px; resize: none; }

        .modal-footer { padding: 20px 25px; border-top: 1px solid #eee; display: flex; gap: 10px; background: #fdfdfd; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #b8962e; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3); }
        .btn-danger { background: #ff6b6b; color: white; flex: 0 0 80px;}
        .btn-danger:hover { background: #e05555; }

        /* Leaflet Icons */
        .icon-base { display: flex !important; justify-content: center; align-items: center; transition: transform 0.2s; }
        .icon-base:hover { transform: scale(1.2); z-index: 1000 !important; cursor: pointer; }
        .icon-orb { text-shadow: 0 0 8px cyan; color: #00d2ff; font-size: 22px !important; }
        .icon-chest { text-shadow: 0 0 8px gold; color: #ffa500; font-size: 22px !important; }
        .icon-teleport { text-shadow: 0 0 8px purple; color: #bd00ff; font-size: 26px !important; }
        .icon-user { filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3)); color: #ff4757; font-size: 28px !important; }

        /* Custom Tooltip */
        .custom-tooltip {
            background: rgba(44, 37, 32, 0.95); border: none; color: #fff;
            border-radius: 6px; padding: 6px 10px; font-size: 13px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .leaflet-tooltip-top::before { border-top-color: rgba(44, 37, 32, 0.95); }

        /* ==================== 8. ä¸»é¡µæ ·å¼ ==================== */
        .home-dashboard {
            max-width: 1200px; margin: 0 auto;
            display: grid; grid-template-columns: 2fr 1fr; gap: 30px;
            padding-bottom: 50px;
        }

        /* æ¬¢è¿æ¨ªå¹… */
        .hero-banner {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--primary), #4a3f35);
            padding: 40px; border-radius: 16px; color: #fff;
            position: relative; overflow: hidden;
            box-shadow: var(--card-shadow);
            display: flex; justify-content: space-between; align-items: center;
        }
        .hero-content h1 { margin: 0 0 10px 0; font-size: 28px; color: var(--accent); }
        .hero-content p { margin: 0; opacity: 0.8; font-size: 14px; }
        .hero-icon { font-size: 80px; color: rgba(255,255,255,0.1); transform: rotate(-15deg); }

        /* é€šç”¨é¢æ¿å®¹å™¨ */
        .panel-box {
            background: #fff; border-radius: 16px; padding: 25px;
            box-shadow: var(--card-shadow); border: 1px solid rgba(0,0,0,0.02);
            height: 100%; display: flex; flex-direction: column;
        }
        .panel-header {
            font-size: 18px; font-weight: bold; color: var(--primary);
            margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-header i { color: var(--accent); margin-right: 8px; }

        /* æ–°é—»åˆ—è¡¨ */
        .news-list { display: flex; flex-direction: column; gap: 15px; }
        .news-item {
            display: flex; align-items: baseline; gap: 10px; padding-bottom: 15px;
            border-bottom: 1px dashed #eee; cursor: pointer; transition: 0.2s;
        }
        .news-item:hover { transform: translateX(5px); }
        .news-tag { 
            font-size: 11px; padding: 2px 6px; border-radius: 4px; color: #fff; background: #999;
            flex-shrink: 0; 
        }
        .tag-update { background: var(--accent); }
        .tag-event { background: #ff6b6b; }
        .news-title { font-size: 14px; color: #444; flex: 1; }
        .news-date { font-size: 12px; color: #999; }

        /* æ”»ç•¥å¡ç‰‡ */
        .guide-grid { display: grid; gap: 15px; }
        .guide-card {
            background: #fdfdfd; padding: 15px; border-radius: 10px; border: 1px solid #eee;
            display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.3s;
        }
        .guide-card:hover { border-color: var(--accent); box-shadow: 0 5px 15px rgba(212, 175, 55, 0.1); }
        .guide-icon {
            width: 45px; height: 45px; background: rgba(212, 175, 55, 0.1); color: var(--accent);
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .guide-info h4 { margin: 0 0 5px 0; font-size: 15px; color: #333; }
        .guide-info p { margin: 0; font-size: 12px; color: #888; }

        /* æ•°æ®æŠ¥å‘Š */
        .report-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box {
            text-align: center; padding: 15px; background: #fcfcfc; border-radius: 10px;
        }
        .stat-num { font-size: 24px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 12px; color: #888; margin-top: 5px; }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .home-dashboard { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <div id="intro-gate">
        <div class="loader-circle"></div>
        <div class="loader-text">å±±æµ·å¯»çµ</div>
        <div style="margin-top:10px; color:#666; font-size:12px; opacity:0; animation:fadeInUp 1s forwards 1s;">æ­£åœ¨æ‰«æå±±æµ·å¤§é™†...</div>
    </div>

    <nav class="navbar">
        <div class="logo"><i class="fa-solid fa-dragon"></i> <span>æ˜Ÿæ¢¦å®å†Œv2.1</span></div>
        <div class="nav-items">	
            <button class="nav-btn active" onclick="switchView('home', this)"><i class="fa-solid fa-house"></i> é¦–é¡µ</button>
            <button class="nav-btn" onclick="switchView('dex', this)"><i class="fa-solid fa-book-journal-whills"></i> å•¾çµå›¾é‰´</button>
            <button class="nav-btn" onclick="switchView('craft', this)"><i class="fa-solid fa-scroll"></i> å¤©å·¥é€ ç‰©</button>
            <button class="nav-btn" onclick="switchView('map', this)"><i class="fa-solid fa-map-location"></i> å±±æµ·å¤§é™†</button>
            <button class="nav-btn" onclick="switchView('breed', this)"><i class="fa-solid fa-yin-yang"></i> å•¾çµèåˆ</button>
        </div>
    </nav>

    <div class="main-container">
        <div id="home" class="view-section active">
            <div class="home-dashboard">
                
                <div class="hero-banner">
                    <div class="hero-content">
                        <h1>æ¬¢è¿å›åˆ°å±±æµ·å¤§é™†</h1>
                        <p>å½“å‰ç‰ˆæœ¬ v2.1 | æ•æ‰çµå…½ï¼Œè®°å½•å¥‡è¿¹</p>
                    </div>
                    <div class="hero-icon"><i class="fa-solid fa-scroll"></i></div>
                </div>

                <div style="display:flex; flex-direction:column; gap:30px;">
                    
                    <div class="panel-box">
                        <div class="panel-header">
                            <span><i class="fa-solid fa-bullhorn"></i> æœ€æ–°é‚¸æŠ¥</span>
                            <span style="font-size:12px; color:#999; cursor:pointer;">æ›´å¤š ></span>
                        </div>
                        <div class="news-list" id="news-container">
                            </div>
                    </div>

                    <div class="panel-box">
                        <div class="panel-header">
                            <span><i class="fa-solid fa-chart-pie"></i> è§‚æµ‹æŠ¥å‘Š</span>
                        </div>
                        <div class="report-stats">
                            <div class="stat-box">
                                <div class="stat-num" id="stat-count">0</div>
                                <div class="stat-label">å·²æ”¶å½•çµå…½</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-num" id="stat-seen">12</div>
                                <div class="stat-label">ä»Šæ—¥ç›®å‡»</div>
                            </div>
                        </div>
                        <div style="font-size:13px; color:#666; line-height:1.6; background:#f9f9f9; padding:15px; border-radius:8px;">
                            <i class="fa-solid fa-quote-left" style="color:#ddd;"></i>
                            æ®è§‚å¯Ÿï¼Œè¿‘æœŸ<b>[ç«ç³»]</b>å•¾çµåœ¨å—éƒ¨çŸ¿åŒºæ´»åŠ¨é¢‘ç¹ï¼Œå»ºè®®æºå¸¦æ°´ç³»çµå…½å‰å¾€æ¢ç´¢ã€‚
                        </div>
                    </div>

                </div>

                <div class="panel-box">
                    <div class="panel-header">
                        <span><i class="fa-solid fa-compass"></i> æ¢é™©æ‰‹è®°</span>
                    </div>
                    <div class="guide-grid" id="guide-container">
                        </div>
                </div>

            </div>
        </div>

        <div id="dex" class="view-section">
            <div class="search-container">
                <input type="text" class="glass-input" id="dexSearch" placeholder="åœ¨æ­¤è¾“å…¥çµå…½ä¹‹å..." oninput="renderDex()">
                <select class="glass-select" id="dexFilter" onchange="renderDex()">
                    <option value="all">å…¨å±æ€§</option>
                    <option value="é‡‘">é‡‘ç³»</option>
                    <option value="æœ¨">æœ¨ç³»</option>
                    <option value="æ°´">æ°´ç³»</option>
                    <option value="ç«">ç«ç³»</option>
                    <option value="åœŸ">åœŸç³»</option>
                    <option value="å¦–">å¦–ç³»</option>
                </select>
            </div>
            <div id="dex-grid" class="grid-layout"></div>
        </div>

        <div id="craft" class="view-section">
             <div class="search-container">
                <input type="text" class="glass-input" id="craftSearch" placeholder="æœç´¢é…æ–¹ (å¦‚: éå…·, é“é”­)..." oninput="renderCraft()">
            </div>
            <div id="recipe-list" class="recipe-list"></div>
        </div>

        <div id="map" class="view-section" style="padding:0; overflow: hidden;">
            <div class="map-wrapper">
                <div id="map-container" style="width:100%; height:100%; background:#a0d2ef;"></div>
                
                <div class="map-layer-control">
                    <div style="font-size: 13px; font-weight: bold; color: #888; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">ç­›é€‰æ ‡è®°</div>
                    <div class="layer-toggle active" onclick="toggleLayer('orb', this)">
                        <i class="fa-solid fa-circle" style="color:#00d2ff;"></i> çµç 
                    </div>
                    <div class="layer-toggle active" onclick="toggleLayer('chest', this)">
                        <i class="fa-solid fa-box-open" style="color:#ffa500;"></i> å®ç®±
                    </div>
                    <div class="layer-toggle active" onclick="toggleLayer('teleport', this)">
                        <i class="fa-solid fa-dungeon" style="color:#bd00ff;"></i> ä¼ é€ç‚¹
                    </div>
                     <div class="layer-toggle active" onclick="toggleLayer('user', this)">
                        <i class="fa-solid fa-location-dot" style="color:#ff4757;"></i> é‡å¤–boss
                    </div>
                    <div style="font-size: 11px; color: #aaa; margin-top: 5px; border-top: 1px solid #eee; padding-top: 8px;">
                        <i class="fa-solid fa-mouse-pointer"></i> ç‚¹å‡»åœ°å›¾æ·»åŠ ç‚¹ä½<br>
                        <i class="fa-solid fa-hand-pointer"></i> ç‚¹å‡»æ ‡è®°æŸ¥çœ‹è¯¦æƒ…
                    </div>
                </div>
            </div>
        </div>

        <div id="breed" class="view-section">
            <div class="breed-stage">
                <h2 style="color:var(--primary); margin-bottom:10px;">å•¾çµèåˆå…¬å¼</h2>
                <p style="color:#888;">å¤©åœ°äº¤æ„Ÿï¼Œä¸‡ç‰©åŒ–ç”Ÿã€‚é€‰æ‹©çˆ¶æ¯çµå…½è¿›è¡Œæ¨æ¼”ã€‚</p>
                
                <div class="calc-row">
                    <select id="p1" class="calc-select" onchange="checkBreed()"><option>é€‰æ‹©çˆ¶æœ¬</option></select>
                    <i class="fa-solid fa-plus icon-plus"></i>
                    <select id="p2" class="calc-select" onchange="checkBreed()"><option>é€‰æ‹©æ¯æœ¬</option></select>
                    <i class="fa-solid fa-arrow-right icon-eq"></i>
                    <div class="result-egg" id="result-egg">
                        <i class="fa-solid fa-egg"></i>
                    </div>
                </div>
                <div id="result-name" style="margin-top:20px; font-size:24px; font-weight:bold; color:var(--accent);">???</div>
            </div>
        </div>

    </div>

    <div id="marker-modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">åœ°ç‚¹è¯¦æƒ…</div>
                <div class="modal-close" onclick="closeModal()"><i class="fa-solid fa-times"></i></div>
            </div>
            
            <div class="modal-body">
                <div class="upload-area" onclick="document.getElementById('marker-img-input').click()">
                    <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                    <div class="upload-text">ç‚¹å‡»æ·»åŠ ç°åœºå›¾ç‰‡</div>
                    <img id="marker-img-preview" class="upload-preview" alt="Preview">
                    <input type="file" id="marker-img-input" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
                </div>

                <div class="form-group">
                    <label class="form-label">æ ‡è®°åç§°</label>
                    <input type="text" id="marker-name" class="form-input" placeholder="ä¾‹å¦‚ï¼šéšè—çš„å®ç®±...">
                </div>

                <div class="form-group">
                    <label class="form-label">æ ‡è®°ç±»å‹</label>
                    <select id="marker-type" class="form-select">
                        <option value="user">ğŸš© é‡å¤–boss</option>
                        <option value="orb">ğŸ”µ çµç </option>
                        <option value="chest">ğŸ“¦ å®ç®±</option>
                        <option value="teleport">â›©ï¸ ä¼ é€ç‚¹</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">è¯¦ç»†æè¿°</label>
                    <textarea id="marker-desc" class="form-textarea" placeholder="åœ¨è¿™é‡Œè®°å½•æ›´å¤šç»†èŠ‚ï¼Œä¾‹å¦‚ï¼šéœ€è¦é£è¡Œåéª‘æ‰èƒ½åˆ°è¾¾..."></textarea>
                </div>
                
                <input type="hidden" id="marker-lat">
                <input type="hidden" id="marker-lng">
                <input type="hidden" id="marker-id">
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveMarkerData()">ä¿å­˜è®°å½•</button>
                <button class="btn btn-danger" id="btn-delete" onclick="deleteCurrentMarker()">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // ================= æ•°æ®ä¸­å¿ƒ =================
        const spirits = [
            {"id": "001", "name": "èœå¶é¸¡", "el": "æœ¨", "job": "è¾…åŠ©", "tags": ["ç‰§åœºLv1"], "desc": "èº«èº¯æµ‘åœ†ï¼Œé™é™åœ°å§åœ¨ç»¿å¶ä¹‹é—´ï¼Œåƒæäº†ä¸€é¢—æ–°é²œçš„å¤§ç™½èœï¼›å…¶é¸¡è›‹è´¨åœ°ç»†è…»ï¼Œå¯Œå«ç»´ç”Ÿç´ å’Œè›‹ç™½è´¨ï¼Œå…¥å£å‘³é“ç¾å¦™"},
            {"id": "002", "name": "ç•¥ç•¥æ±ª", "el": "æ— ", "job": "è¾…åŠ©", "tags": ["æ‰‹å·¥Lv1", "ä¼æœ¨Lv1", "æ¬è¿Lv1"], "desc": "å¾ˆå¸¸è§çš„å•¾çµï¼ŒåèˆŒå¤´æ˜¯æ ‡å¿—æ€§è¡¨æƒ…"},
            {"id": "003", "name": "ç½—æ±‰é¼ ", "el": "åœŸ", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv1", "çŸ¿Lv1"], "desc": "ä¼šæ²‰è¿·é‡å¤æ€§å·¥ä½œï¼Œè„¾æ°”å·®ï¼›è‹¥æ‰“æ–­å®ƒåšäº‹ï¼Œä¼šå‡¶ç‹ å’†å“®å¹¶æŒ¥èµ·æ„¤æ€’çš„å°æ‹³å¤´"},
            {"id": "004", "name": "ç»’ç»’ç¾Š", "el": "æ— ", "job": "è¾…åŠ©", "tags": ["ç‰§åœºLv1"], "desc": "æ²¾äº†æ°´ä¼šç§»åŠ¨å›°éš¾ï¼›è·¯è¾¹å¸¸è§èººç€ä¸åŠ¨çš„ç»’ç»’ç¾Šï¼Œéæ‡’ï¼Œè€Œæ˜¯ç­‰å¾…å¤ªé˜³æ™’å¹²è‡ªå·±"},
            {"id": "005", "name": "æ¾æ¾é±¼", "el": "æ°´", "job": "è¾“å‡º", "tags": ["æµ‡æ°´Lv1"], "desc": "ç”Ÿæ´»åœ¨æµ…æµ·åŒºåŸŸï¼Œä¸¤é¢—é—¨ç‰™ææŠ¢çœ¼ï¼›å› çœ¼ç¥ä¸å¥½ï¼Œå¸¸æ— æ³•åˆ†è¾¨å’¬çš„æ˜¯è´å£³è¿˜æ˜¯çŸ³å¤´"},
            {"id": "006", "name": "æ¢¦äº‘å¦–", "el": "å¦–", "job": "è¾…åŠ©", "tags": ["æ‰‹å·¥Lv1", "ä¼æœ¨Lv1", "æ¬è¿Lv1"], "desc": "å¯çˆ±çš„å¤–å½¢å’Œè½¯èŒçš„è¡¨æƒ…å…·æœ‰ç›¸å½“å¤§çš„è¿·æƒ‘æ€§"},
            {"id": "007", "name": "æ˜Ÿæ±ªæ±ª", "el": "æ— ", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv1", "é‡‡çŸ¿Lv1", "æ¬è¿Lv1"], "desc": "çœ¼ä¸­é—ªçƒç€å¥½å¥‡ä¸çƒ­æƒ…ï¼Œæ€§æ ¼æ¸©é¡ºå´å……æ»¡æ´»åŠ›"},
            {"id": "008", "name": "å—ç“œçŒ´", "el": "æœ¨", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv1", "ä¼æœ¨Lv1", "æ’­ç§Lv1"], "desc": "ä¼ è¯´å—ç“œçŒ´æ˜¯æ’­ç§å¥³ç¥åˆ›é€ çš„å•¾çµ"},
            {"id": "009", "name": "é™¶é™¶é¹¿", "el": "æ— ", "job": "å¦å…‹", "tags": ["é‡‡çŸ¿Lv1", "æ¬è¿Lv1"], "desc": "å–œæ¬¢å‘†ç€ä¸€åŠ¨ä¸åŠ¨ï¼Œæ€»è®©äººè¯¯ä»¥ä¸ºå®ƒæ˜¯ä¸€ä»¶æ˜“ç¢çš„è£…é¥°å“"},
            {"id": "010", "name": "èèå…”", "el": "ç«", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv1", "ç”Ÿç«Lv1"], "desc": "å¤´é¡¶æœ‰ç€ä¸€æ”¯é•¿äº®çš„çƒ›ç«ï¼Œçƒ›å…‰ä¸­é—ªçƒçš„ç«ç„°"},
            {"id": "011", "name": "å‘ç¦è¶", "el": "æœ¨", "job": "æ²»ç–—", "tags": ["æ‰‹å·¥Lv1", "ç§æ¤Lv1"], "desc": "è¿™ç§å•¾çµå‹¤åŠ³è€Œå®³ç¾ï¼Œç»å¸¸åŸ‹å¤´å¹²æ´»å„¿"},
            {"id": "012", "name": "å¥½å†·è›™", "el": "å†°ã€æ°´", "job": "è¾“å‡º", "tags": ["æµ‡æ°´Lv1", "åˆ¶å†·Lv1"], "desc": "ç»å¸¸å¯ä»¥åœ¨æ²³æµè¾¹å‘ç°å®ƒçš„è¸ªè¿¹ã€‚å®ƒçš„çš®è‚¤ä¼šæ•£å‘å¯’æ°”"},
            {"id": "013", "name": "å’ªèœ‚", "el": "é‡‘", "job": "è¾“å‡º", "tags": ["ç‰§åœºLv1"], "desc": "å¿«ä¹æ—¶ä¼šé‡Šæ”¾å‡ºç”œåº¦è¶…æ ‡çš„èœ‚èœœ"},
            {"id": "014", "name": "å™—å™—", "el": "å†°", "job": "è¾…åŠ©", "tags": ["æ‰‹å·¥Lv1", "æµ‡æ°´Lv1", "æŒ–çŸ¿Lv1", "å†°å†»Lv1"], "desc": "å†°åŸä¸Šçš„ä¼˜é›…ä½¿è€…ï¼Œèƒ½å¤Ÿåœ¨å¯’å†·ä¸­è½»æ¾ç©¿è¡Œ"},
            {"id": "015", "name": "è’œæ³¥ç‰›", "el": "åœŸ", "job": "å¦å…‹", "tags": ["ä¼æœ¨Lv1", "ç§æ¤Lv1"], "desc": "ç»å¸¸æŒ‚ç€çœ¼æ³ªï¼Œæ˜¾å¾—å¯æ€œå…®å…®çš„å•¾çµï¼Œä½†å®ƒåªæ˜¯è¢«è‡ªå·±çš„è’œæ³¥å‘³ç»™è¾£åˆ°äº†"},
            {"id": "016", "name": "æµªå°¾ä»™", "el": "å†°ã€æ°´", "job": "è¾“å‡º", "tags": ["æµ‡æ°´Lv2", "åˆ¶å†·Lv1"], "desc": "æŠ«ç€æ°´ç å¹»åŒ–æˆçš„åä¸½ç¾½æ¯›ï¼Œå§¿æ€ä¼˜é›…"},
            {"id": "017", "name": "æ¢¦å¥‡", "el": "å¦–", "job": "å¦å…‹", "tags": ["æ‰‹å·¥Lv2", "çŸ¿Lv1"], "desc": "å±…ä½åœ¨æ£®æ—ä¸­çš„ç¥å¥‡ç”Ÿç‰©"},
            {"id": "018", "name": "èƒ†å°é¾Ÿ", "el": "åœŸ", "job": "è¾…åŠ©", "tags": ["æ¬è¿Lv1", "é‡‡çŸ¿Lv1"], "desc": "æä¸ºèƒ†å°çš„å•¾çµï¼Œæœ‰ä»»ä½•é£å¹è‰åŠ¨å°±ä¼šç´§å¼ åœ°èº²è¿›é¾Ÿå£³"},
            {"id": "019", "name": "çŒ«é­…å„¿", "el": "å¦–", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv1", "æ¬è¿Lv1", "åˆ¶è¯Lv1"], "desc": "çŒ«é­…å„¿æ“…é•¿åˆ†è¾¨å„ç§è¯æ"},
            {"id": "020", "name": "é¾™é©¬é©¹", "el": "é¾™", "job": "å¦å…‹", "tags": ["æ¬è¿Lv2"], "desc": "æ‹¥æœ‰äº‘æœµèˆ¬é¬ƒå•¾çµæ¯›çš„ç¾ä¸½å•¾çµ"},
            {"id": "021", "name": "ç´«è¶å–µ", "el": "å¦–", "job": "å¦å…‹", "tags": ["æ‰‹å·¥Lv1", "æŒ–çŸ¿Lv2"], "desc": "è¡ŒåŠ¨èµ·æ¥ååˆ†çµæ´»ï¼Œèƒ½èœ·ç¼©ç€æ‰‹è„šå˜æˆçƒæ»šæ¥æ»šå»"},
            {"id": "022", "name": "ç„°å¸ˆå‚…", "el": "ç«", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv1", "æ¬è¿Lv2", "ç”Ÿç«Lv2"], "desc": "è¿™ç§å•¾çµå…¨èº«ç«çº¢ï¼Œä»¿ä½›ç‡ƒçƒ§çš„ç«ç„°"},
            {"id": "023", "name": "é’è¢–å›", "el": "æœ¨", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv3"], "desc": "é’è¢–å›å‰è‚¢ä¸Šçš„å¤§é’³å­æ˜¯æä¸ºé”‹åˆ©çš„æ­¦å™¨"},
            {"id": "024", "name": "çŸ³ç‚ç‹®", "el": "ç«", "job": "è¾“å‡º", "tags": ["ç”Ÿç«Lv3", "æŒ–çŸ¿Lv2"], "desc": "è¿™ç§å•¾çµå…¨èº«ç«ç„°é¬ƒå•¾çµæ¯›ï¼Œå¦‚ä¸ç­çš„ç‚¬ç«"},
            {"id": "025", "name": "é”¦é¹°å«", "el": "æ— ", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv2", "ä¼æœ¨Lv2"], "desc": "ä¸å–œç¾¤å±…ï¼Œæ€»æ˜¯ç‹¬æ¥ç‹¬å¾€"},
            {"id": "026", "name": "è‰çŒ¿å±±", "el": "æœ¨", "job": "å¦å…‹", "tags": ["æ‰‹å·¥Lv1", "ä¼æœ¨Lv4", "æ¬è¿Lv1"], "desc": "å…¨èº«çš„èŠ±èŠ±è‰è‰è®©å®ƒåƒæ´»åŠ¨çš„å±±"},
            {"id": "027", "name": "é’é“œé›€", "el": "é‡‘", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv1", "å‘ç”µLv1"], "desc": "å®ƒèº«ä¸Šçš„é’é“œèŠ±çº¹å’Œç”µæµå¾®å…‰ï¼Œæ•£å‘å‡ºå¤è€è€Œç¥ç§˜çš„æ°”æ¯"},
            {"id": "028", "name": "çŒªä¸½å¶", "el": "æœ¨", "job": "å¦å…‹", "tags": ["ä¼æœ¨Lv1", "æ’­ç§Lv2"], "desc": "çˆ±å¹²å‡€ï¼Œå¯¹è‡ªå·±çš„å¤–è¡¨éå¸¸åœ¨æ„"},
            {"id": "029", "name": "åè›‹è›‹", "el": "å¦–", "job": "è¾“å‡º", "tags": ["åˆ¶è¯Lv1"], "desc": "å–œæ¬¢ä¼ªè£…æˆæ™®é€šçš„è›‹ï¼Œèº²åœ¨å…¶å®ƒå•¾çµçš„å·¢ç©´é‡Œè¹­åƒè¹­å–"},
            {"id": "030", "name": "èšŒåœç ", "el": "æ°´", "job": "å¦å…‹", "tags": ["æµ‡çŒLv1"], "desc": "ç”Ÿæ´»åœ¨å¹½æ·±æµ·åŸŸï¼Œå´æœ‰ç€æŸ”è½¯çš„å¤–å£³"},
            {"id": "031", "name": "æ£å¼¹é±¿", "el": "ç«", "job": "è¾…åŠ©", "tags": ["æ¬è¿Lv1", "ç”Ÿç«Lv2"], "desc": "æ£å¼¹é±¿çš„è§¦è§’å¯å–·å°„å‡ºå¼ºå¤§çš„ç«ç„°"},
            {"id": "032", "name": "æ˜Ÿæµ·å§¬", "el": "æ°´", "job": "è¾“å‡º", "tags": ["æ¬è¿Lv2", "æµ‡æ°´Lv2", "åˆ¶è¯Lv1"], "desc": "ç”Ÿæ´»åœ¨æµ·æ´‹åŒºåŸŸçš„å•¾çµï¼Œæ‹¥æœ‰æ•°é‡ç¹å¤šçš„è§¦æ‰‹"},
            {"id": "033", "name": "é›·ç”µé¹¿", "el": "é‡‘", "job": "è¾…åŠ©", "tags": ["ä¼æœ¨Lv1", "å‘ç”µLv1"], "desc": "ä¸è¦è¢«å®ƒå¯çˆ±é—ªäº®çš„å¤–è¡¨è¿·æƒ‘"},
            {"id": "034", "name": "èŠ±ä¼èœ¥", "el": "æ°´", "job": "è¾…åŠ©", "tags": ["ç‰§åœºLv1"], "desc": "æ€§æ ¼æ¸©å’Œçš„å¯çˆ±å•¾çµï¼Œå¤´é¡¶é¡¶ç€å·¨å¤§çš„èŠ±ç“£æ–—ç¯·"},
            {"id": "035", "name": "ç‰›ææ", "el": "æ— ", "job": "è¾…åŠ©", "tags": ["ç‰§åœºLv1"], "desc": "æ€»æ˜¯ç”¨å‰è¹„æ‚ç€èƒ¸ï¼Œçªç€å¤§çœ¼ç›"},
            {"id": "036", "name": "ç¿ ç¿é¹°", "el": "æœ¨", "job": "è¾…åŠ©", "tags": ["ç§æ¤Lv2"], "desc": "æ –æ¯åœ¨é«˜å¤§çš„æ ‘æœ¨ä¸Šï¼Œç¿ ç»¿çš„ç¿ç¾½ä¸ŠæµåŠ¨ç€ â€œç”Ÿâ€ ä¹‹åŠ›é‡"},
            {"id": "037", "name": "é¾™æ‘†æ‘†", "el": "é¾™ã€æ°´", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv1", "æµ‡æ°´Lv2"], "desc": "æ®è¯´æ˜¯å¼ºå¤§çš„ä¸Šå¤ç”Ÿç‰©åä»£ï¼Œä½†å¹¶ä¸çƒ­è¡·äºæ”»å‡»å…¶ä»–ç”Ÿçµ"},
            {"id": "038", "name": "ç´«èé¹°", "el": "å¦–", "job": "è¾…åŠ©", "tags": ["ä¼æœ¨Lv2"], "desc": "å®ƒå¾ˆå°‘çœ¨çœ¼ï¼Œæ‹¥æœ‰å“è¶Šçš„å¤œè§†èƒ½åŠ›"},
            {"id": "039", "name": "å½±å¸ˆå‚…", "el": "å¦–", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv2", "ç”Ÿç«Lv2", "é‡‡çŸ¿Lv2"], "desc": "å’Œç„°å¸ˆå‚…åŒæºåŒå®—çš„ä¸€ç§å•¾çµ"},
            {"id": "040", "name": "ç‚½ç†ŠçŒ«", "el": "ç«", "job": "å¦å…‹", "tags": ["æ‰‹å·¥Lv1", "æ¬è¿Lv2", "ç”Ÿç«Lv2"], "desc": "ç‚½ç†ŠçŒ«ä½“è¡¨æ˜äº®å¦‚ç«ç„°èˆ¬çš„å•¾çµæ¯›å‘åœ¨æ£®æ—ä¸­æ ¼å¤–å¼•äººæ³¨ç›®"},
            {"id": "041", "name": "å¤©ç¦„", "el": "å†°", "job": "è¾…åŠ©", "tags": ["æ‰‹å·¥Lv2", "åˆ¶å†·Lv1"], "desc": "ä¼ è¯´ä¸­æ‹›è´¢è¿›å®çš„ç¥å…½ï¼Œç°åœ¨åªæ˜¯ä¸ªæš´èºå•¾çµæ¯›çƒ"},
            {"id": "042", "name": "ç©¿å±±å®¢", "el": "åœŸ", "job": "è¾“å‡º", "tags": ["é‡‡çŸ¿Lv3"], "desc": "å®ƒä»¬çš„å¤–å£³åƒç›”ç”²ä¸€æ ·åšç¡¬"},
            {"id": "043", "name": "é”é¹¤ä»™", "el": "é‡‘", "job": "è¾“å‡º", "tags": ["å‘ç”µLv3"], "desc": "å–œæ¬¢åœ¨ç©ºä¸­è‡ªç”±ç¿±ç¿”çš„å•¾çµ"},
            {"id": "044", "name": "ç¢§æµ·ç„æ­¦", "el": "æ°´", "job": "å¦å…‹", "tags": ["æµ‡çŒLv5", "ç§æ¤Lv4"], "desc": "å¤ä»£ä¹¦ç±ä¸­è®°è½½çš„å››å¤§åœ£å…½ä¹‹ä¸€"},
            {"id": "045", "name": "ç‹å¨‡å¨‡", "el": "ç«", "job": "è¾“å‡º", "tags": ["æ¬è¿Lv1", "ç”Ÿç«Lv2"], "desc": "å®ƒçœ‹èµ·æ¥å°±å¾ˆå‚²å¨‡ï¼Œå–œæ¬¢ç‹¬æ¥ç‹¬å¾€"},
            {"id": "046", "name": "æ°´æ»´èŸ¹", "el": "æ°´", "job": "è¾“å‡º", "tags": ["æµ‡æ°´Lv2", "é‡‡çŸ¿Lv1"], "desc": "å®ƒæœ€æ˜¾çœ¼çš„æ˜¯é‚£ä¸€å¯¹å·¨å¤§çš„æ°´æ»´é’³å­"},
            {"id": "047", "name": "äº‘ç¿…é¾™", "el": "é£", "job": "è¾“å‡º", "tags": ["æµ‡æ°´Lv2", "é‡‡çŸ¿Lv2"], "desc": "äº‘ç¿…é¾™å¿«é€Ÿæ‰‡åŠ¨ç¿…è†€æ—¶ï¼Œèƒ½æ…åŠ¨å‘¨å›´çš„æ°”æµ"},
            {"id": "048", "name": "çŸ³çœ‰çŒª", "el": "åœŸ", "job": "å¦å…‹", "tags": ["æ¬è¿Lv2", "é‡‡çŸ¿Lv2"], "desc": "çŸ³çœ‰çŒªåŠ›å¤§å¦‚ç‰›ï¼Œé€Ÿåº¦æ•æ·"},
            {"id": "049", "name": "ç„ä¹Œéª“", "el": "æ— ", "job": "å¦å…‹", "tags": ["æ¬è¿Lv3"], "desc": "ç„é©¬åœ¨é»‘å¤œä¸­å‡ºç”Ÿï¼Œå¥”è·‘èµ·æ¥åƒå¤œé£ä¸€æ ·è½»ç›ˆ"},
            {"id": "050", "name": "å†°åˆƒè±¹", "el": "å†°", "job": "è¾“å‡º", "tags": ["åˆ¶å†·Lv2"], "desc": "åœ¨å†°éœœä¹‹åœ°å‡ºæ²¡ï¼Œæ‹¥æœ‰é”‹åˆ©çš„å°¾å·´å’Œçˆªå­"},
            {"id": "051", "name": "çŒ«é­…å§¬", "el": "å¦–", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv3", "åˆ¶è¯Lv3"], "desc": "çŒ«é­…å§¬å¯ä»¥æ„Ÿåº”æ¤ç‰©çš„èƒ½é‡"},
            {"id": "052", "name": "é²²", "el": "æ°´", "job": "å¦å…‹", "tags": ["æµ‡æ°´Lv3", "æ¬è¿Lv3"], "desc": "é²²èº«ä½“ä¸¤ä¾§çš„é³ä¸å…¶è¯´åƒé±¼ï¼Œä¸å¦‚è¯´æ›´åƒç¿…è†€"},
            {"id": "053", "name": "æœˆè›¾çµ", "el": "æ— ", "job": "æ²»ç–—", "tags": ["æ‰‹å·¥Lv2", "ç§æ¤Lv2", "åˆ¶è¯Lv2"], "desc": "è¯ç”Ÿäºæœˆå‡ä¹‹åœ°ï¼Œè¢«ä¼ é¢‚ä¸ºæœˆå…‰çš„ä½¿è€…"},
            {"id": "054", "name": "åƒå±±ç‰›", "el": "åœŸ", "job": "å¦å…‹", "tags": ["æŒ–çŸ¿Lv3", "æ¬è¿Lv2"], "desc": "è¿™ç§å•¾çµçš®è‚¤ä¸Šæµè½¬ç€å±±å·ä¸æ²³æµçš„å›¾æ¡ˆ"},
            {"id": "055", "name": "é‡‘é¬ƒçŒª", "el": "é‡‘", "job": "å¦å…‹", "tags": ["å‘ç”µLv3"], "desc": "é‡‘é¬ƒçŒªçš„è€³æœµèƒ½çµæ•åœ°æ•æ‰åˆ°åœ°ä¸‹æˆ–è€…å±±è…¹çš„å£°å“"},
            {"id": "057", "name": "é’å½±ç†ŠçŒ«", "el": "æœ¨", "job": "å¦å…‹", "tags": ["æ‰‹å·¥Lv2", "ä¼æœ¨Lv2", "æ¬è¿Lv2", "åˆ¶è¯Lv2"], "desc": "é’å½±ç†ŠçŒ«åœ†æ»šæ»šçš„è‚šçš®é‡Œè•´å«ç€ç”Ÿå‘½ä¹‹åŠ›"},
            {"id": "058", "name": "å¦–è¶ä»™", "el": "æœ¨", "job": "æ²»ç–—", "tags": ["æ‰‹å·¥Lv2", "ç§æ¤Lv3", "åˆ¶è¯Lv3"], "desc": "ä¼šä½è¯­åŸå”±çš„å•¾çµï¼Œæ‰‹æŒèŠ±æœµåŸå”±ç”Ÿå‘½ä¹‹æ­Œ"},
            {"id": "060", "name": "é‚ªç‚å–µ", "el": "å¦–ã€ç«", "job": "å¦å…‹", "tags": ["æ‰‹å·¥Lv3", "ç”Ÿç«Lv4"], "desc": "å®ƒèƒ½å¤Ÿæ“æ§çƒ§ç¼çµé­‚çš„ä¹å¹½ä¹‹ç«ï¼Œæ€»æ˜¯éœ²å‡ºé‚ªæ¶çš„ç‹ç¬‘"},
            {"id": "061", "name": "æ°´äº‘å›", "el": "æ°´", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv3", "æµ‡æ°´Lv4"], "desc": "è¿™ç§å•¾çµé€šå¸¸æ –æ¯äºé«˜å±±ä¹‹å·…æˆ–é è¿‘æ¸…æ¾ˆæ¹–æ³Šçš„åœ°åŒº"},
            {"id": "062", "name": "æµ·æ´‹ç†Š", "el": "æ°´", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv2", "æµ‡æ°´Lv4", "æ¬è¿Lv3"], "desc": "å¤´ä¸Šçš„çŠç‘šè§’å’Œèº«ä¸Šçš„è„‘çŠç‘šçº¹æ ·ï¼Œéƒ½è¡¨æ˜è¿™ç§å•¾çµä¼¼ä¹æ¥è‡ªç¥ç§˜çš„æµ·åº•ä¸–ç•Œ"},
            {"id": "063", "name": "é›·çŒ´", "el": "é‡‘", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv5", "å‘ç”µLv3", "é‡‡çŸ¿Lv4"], "desc": "å®ƒèƒ½å¬å”¤ä¸‡é’§é›·éœ†ï¼Œçœ‹åˆ°å…¶ä»–å•¾çµæ‰“æ¶ï¼Œå°±ä¼šåŠ å…¥æˆ˜æ–—ç”¨è‡ªå·±çš„æ–¹å¼åŠæ¶"},
            {"id": "064", "name": "ç«æ‹³é¼ ", "el": "ç«", "job": "è¾“å‡º", "tags": ["ç”Ÿç«Lv4", "æŒ–çŸ¿Lv3"], "desc": "è¿™ç§å•¾çµåŒæ‹³è¢«ç‡ƒçƒ§çš„ç«ç„°åŒ…å›´"},
            {"id": "066", "name": "ç‰åé¹¿", "el": "å†°", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv4"], "desc": "å·¨å¤§çš„è§’æ®è¯´æ˜¯åƒå¹´ç„å†°å‡ç»“è€Œæˆ"},
            {"id": "068", "name": "ç„å†°ç™½è™", "el": "é‡‘ã€å†°", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv3", "æ¬è¿Lv5", "å‘ç”µLv4"], "desc": "å¤ä»£ä¹¦ç±ä¸­è®°è½½çš„å››å¤§åœ£å…½ä¹‹ä¸€"},
            {"id": "069", "name": "ç‘é‡‘èŸ¾", "el": "é‡‘", "job": "è¾…åŠ©", "tags": ["ç‰§åœºLv1"], "desc": "è±¡å¾è´¢å¯Œä¸å¥½è¿ï¼Œè·³è·ƒæˆ–æ‰“æ»šæ—¶å¯èƒ½æ•£è½é‡‘å¸"},
            {"id": "070", "name": "å¼¦ä¹é¾™", "el": "é¾™ã€åœŸ", "job": "è¾“å‡º", "tags": ["æŒ–çŸ¿Lv3", "æ¬è¿Lv3"], "desc": "å¤©ç„¶å¤§å‹ä¹å™¨ï¼Œå¾®é£æ‹‚è¿‡å‘ä¹éŸ³"},
            {"id": "071", "name": "å…«æ–¤", "el": "é¾™", "job": "è¾“å‡º", "tags": ["ç§æ¤Lv2", "æ¬è¿Lv1"], "desc": "é¾™è„¸çŒ«èº«ï¼Œä½“å‹å°å·§å´é‡å…«æ–¤ï¼ŒæŒæ¡é¾™å¼"},
            {"id": "072", "name": "äºŒä¸¤", "el": "é¾™", "job": "å¦å…‹", "tags": ["ç§æ¤Lv2", "æ‰‹å·¥Lv1", "åˆ¶è¯Lv1"], "desc": "é¾™ä¸ç“¦çŒ«æ··è¡€ï¼Œå‡ºç”Ÿé‡äºŒä¸¤ï¼Œæ“…é•¿å’Œæ³¥å·´"},
            {"id": "073", "name": "äº‘æµ·éº’éºŸ", "el": "é¾™", "job": "è¾“å‡º", "tags": ["æµ‡æ°´Lv3", "æ¬è¿Lv4", "å‘ç”µLv3"], "desc": "èº«èº¯é«˜æ˜‚è€Œæµç•…ä¼˜é›…ï¼Œé«˜è´µéª„å‚²"},
            {"id": "074", "name": "å¶çµç‹", "el": "æœ¨ã€å¦–", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv2", "ç§æ¤Lv3", "æ¬è¿Lv2"], "desc": "å°¾å·´åƒå·¨å¤§çš„èŠ±è‰å¶å­"},
            {"id": "075", "name": "ç°é›¾å¦–", "el": "å¦–", "job": "è¾…åŠ©", "tags": ["æ‰‹å·¥Lv2", "æ¬è¿Lv3", "åˆ¶å†·Lv3"], "desc": "ç¥ç§˜ä¸”å–„å˜ï¼Œé»„æ˜æ—¶è·³ä¼˜é›…èˆè¹ˆå¬å”¤é›¾æ°”è®©äººè¿·è·¯"},
            {"id": "076", "name": "è›¾ç¿…é±¼", "el": "æ°´", "job": "è¾“å‡º", "tags": ["æµ‡æ°´Lv2"], "desc": "é¢å¸¦å¹¸ç¦å¾®ç¬‘ï¼Œå‡ºæ²¡åŒºåŸŸæ›¾å‡ºç°äº‰ç›¸è®¸æ„¿çš„ç››å†µ"},
            {"id": "077", "name": "ç‹¬è§’çµ", "el": "å¦–", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv2", "æ¬è¿Lv3"], "desc": "é“¶æ²³æ¸…æ™°æ—¶å¯åœ¨å¤©ç©ºæ¼«æ­¥"},
            {"id": "078", "name": "ç†”ç«çµ", "el": "ç«", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv2", "æ¬è¿Lv3", "ç”Ÿç«Lv2"], "desc": "é€šä½“é›ªç™½ï¼Œå¤´é¡¶å°–è§’å’Œé¬ƒå•¾çµæ¯›æ¸©åº¦æé«˜"},
            {"id": "079", "name": "åå®ç¥é¼¬", "el": "æ— ", "job": "æ²»ç–—", "tags": ["æ‰‹å·¥Lv1", "æ¬è¿Lv1", "é‡‡çŸ¿Lv1"], "desc": "è±¡å¾ç€è´¢å¯Œçš„ç¥é¼¬"},
            {"id": "080", "name": "æ´—æ¾¡é³„", "el": "æ°´", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv2", "æµ‡æ°´Lv2"], "desc": "ç‹¬ç‰¹è€Œè°ƒçš®çš„å•¾çµï¼Œç»å¸¸è·Ÿç€éŸ³ä¹èŠ‚å¥å¿«é€Ÿç”©å¤´"},
            {"id": "081", "name": "ç”œæ±ªæ±ª", "el": "æ— ", "job": "è¾“å‡º", "tags": ["ç‰§åœºLv1"], "desc": "èº«ä½“åƒæ˜¯ç”±å¥¶ç³–å¡‘é€ è€Œæˆï¼Œæ•£å‘ç€æ·¡æ·¡çš„ç”œé¦™"},
            {"id": "082", "name": "æ˜Ÿæ¢¦", "el": "é¾™ã€å†°", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv2", "ä¼æœ¨Lv3", "æ¬è¿Lv2", "é‡‡çŸ¿Lv3"], "desc": "æœ‰ç€ä¸€æ¡å½¢ä¼¼å•¾çµæ¯›ç¬”çš„é•¿å°¾ï¼Œé’è“è‰²å¤§çœ¼ç›ä»¿ä½›èƒ½æŠ˜å°„å‡ºä¸‡åƒå…‰å½©å¼•äººå…¥æ¢¦"},
            {"id": "084", "name": "å¹½å¤œå¹»è¶", "el": "å¦–", "job": "è¾“å‡º", "tags": ["åˆ¶è¯Lv3", "æ‰‹å·¥Lv3", "æ’­ç§Lv2"], "desc": "å—é«˜å¡”å½±å“ï¼Œæ²‰è¿·è¿·é›¾ä½è¯­"},
            {"id": "085", "name": "æŠ«ç«èœ¥", "el": "ç«", "job": "è¾…åŠ©", "tags": ["æ‰‹å·¥Lv1", "ç”Ÿç«Lv1", "é‡‡çŸ¿Lv1"], "desc": "æ€§æ ¼å®³ç¾ï¼Œæ·¡æ©™çº¢èº«ä½“å¸æ”¶æŠ˜å°„é˜³å…‰"},
            {"id": "086", "name": "å²©é¼“å–µ", "el": "åœŸ", "job": "å¦å…‹", "tags": ["æ‰‹å·¥Lv2", "é‡‡çŸ¿Lv2"], "desc": "ä½“å‹å¦‚æ°”çƒä½†ä½“è¡¨ç¡¬å¦‚å²©çŸ³"},
            {"id": "087", "name": "é’ç¬‹èŸ¹", "el": "æœ¨", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv2", "æ’­ç§Lv1"], "desc": "æœ‰ä¸€åŒç¿ ç»¿è‰²çš„å¤§é’³å­"},
            {"id": "089", "name": "å‡›é¹¤ä»™", "el": "æ— ", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv2", "åˆ¶å†·Lv3"], "desc": "æ –æ¯äºæ°¸ä¹…å†»åœŸé›ªå±±ï¼Œæš´é›ªå¯è‡ªç”±é£è¡Œ"},
            {"id": "090", "name": "çŒ«ç„°å§¬", "el": "ç«", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv4", "ç”Ÿç«Lv3"], "desc": "å¯æ„Ÿåº”ç”Ÿç‰©æ¸©åº¦æ•çŒ"},
            {"id": "093", "name": "å‘è•‰çŒ´", "el": "åœŸ", "job": "è¾“å‡º", "tags": ["æ’­ç§Lv1", "é‡‡çŸ¿Lv1"], "desc": "æ€»æ˜¯å¿§éƒï¼Œæˆ–è®¸åœ¨æ€è€ƒå»å“ªç‰‡æ£®æ—æ•´ç‚¹æ°´æœ"},
            {"id": "094", "name": "ç²‰å™—å™—", "el": "å¦–", "job": "è¾…åŠ©", "tags": ["æ‰‹å·¥Lv1", "ç”Ÿç«Lv1", "é‡‡çŸ¿Lv1"], "desc": "å†°åŸå¯çˆ±èˆè€…ï¼Œèƒ½åœ¨é£é›ªä¸­æ—‹è½¬èˆè¹ˆ"},
            {"id": "095", "name": "è’œç“£ç‰›", "el": "æ— ", "job": "å¦å…‹", "tags": ["ä¼æœ¨Lv1", "æ’­ç§Lv1"], "desc": "æ•£å‘å¼ºçƒˆè’œå‘³ï¼Œçœ¼è§’æ³ªç æ˜¯è¢«è‡ªå·±è¾£åˆ°çš„è‡ªç„¶ååº”"},
            {"id": "096", "name": "å·¥æ©™ç‹®", "el": "æœ¨", "job": "å¦å…‹", "tags": ["æ‰‹å·¥Lv2", "æ¬è¿Lv2"], "desc": "æ”¶é›†ç§å­æ’­æ’’æ£®æ—å‚¬ç”Ÿä½œç‰©"},
            {"id": "097", "name": "é‡‘è¢–å›", "el": "é‡‘", "job": "è¾“å‡º", "tags": ["æ‰‹å·¥Lv1", "ä¼æœ¨Lv3", "å‘ç”µLv1", "æ¬è¿Lv1"], "desc": "èº«å§¿çº¤ç»†ï¼ŒåŒé’³åˆ€åˆƒé”‹åˆ©è€ŒåšéŸ§"},
            {"id": "098", "name": "å•¸æœˆå¦–å›", "el": "æ°´", "job": "è¾“å‡º", "tags": ["ä¼æœ¨Lv3", "æµ‡æ°´Lv3"], "desc": "å—é«˜å¡”å½±å“ï¼Œç—´è¿·å¸æ”¶æœˆåèƒ½é‡"},
            {"id": "099", "name": "è†å† ç‹‚çŒ¿", "el": "åœŸ", "job": "è¾“å‡º", "tags": ["æ¬è¿Lv3"], "desc": "å—é«˜å¡”å½±å“åï¼Œèº«ä¸Šçš„è†æ£˜å’ŒçŸ¿çŸ³è®©è†å† ç‹‚çŒ¿æ°¸è¿œå¤„åœ¨å‘ç‹‚æ˜“æ€’çš„çŠ¶æ€"},
            {"id": "101", "name": "å‡Œå¹½é©¹", "el": "é¾™", "job": "è¾…åŠ©", "tags": ["æ¬è¿Lv2"], "desc": "å‡Œå¹½é©¹é€šä½“æ·¡ç´«ï¼Œèº«ä½“ä¸Šçš„é¬ƒå•¾çµæ¯›å‘ˆé€æ˜è™šå¹»çŠ¶"}
        ];

        const recipes = [
            { name: "åˆçº§å•¾çµè‘«èŠ¦", type: "æ¶ˆè€—", lv: 5, mat: "1æ˜Ÿå¶çŸ³, 6æœ¨æ, 3çŸ³å¤´" },
            { name: "é¾™é©¬é©¹çš„éå…·", type: "éå…·", lv: 7, mat: "20æœ¨æ, 5çº¤ç»´" },
            { name: "é“åˆ¶é•å¤´", type: "å·¥å…·", lv: 28, mat: "10é“é”­, 50çŸ³å¤´" },
            { name: "ä¼ å¥‡å•¾çµè‘«èŠ¦", type: "æ¶ˆè€—", lv: 50, mat: "6æ˜Ÿå¶çŸ³, 8ç¢³çº¤ç»´" }
        ];

        const newsData = [
            { type: 'update', label: 'æ›´æ–°', title: 'v2.1ç‰ˆæœ¬å‘å¸ƒï¼šæ–°å¢"å±±æµ·åœ°å›¾"åŠŸèƒ½', date: '11-28' },
            { type: 'event', label: 'æ´»åŠ¨', title: 'æ‰¾è€é‚“å¯„å­˜å•¾çµå»æ­£å¼æœ', date: '11-27' },
            { type: 'news', label: 'æ–°é—»', title: 'å…³äº"æ£å¼¹é±¿"æŠ€èƒ½æ•°å€¼è°ƒæ•´çš„å…¬å‘Š', date: '11-25' },
            { type: 'news', label: 'æ–°é—»', title: 'æ–°æ‰‹æ¢é™©å®¶å…¥é©»æŒ‡å—', date: '11-20' }
        ];

        const guideData = [
            { title: 'å±æ€§å…‹åˆ¶è¡¨', desc: 'é‡‘å…‹æœ¨ï¼Œæœ¨å…‹åœŸï¼Œæ°´å…‹ç«...', icon: 'fire' },
            { title: 'ç¨€æœ‰è›‹åˆ†å¸ƒ', desc: 'å…¨åœ°å›¾é«˜é˜¶çµå…½ç‚¹ä½ä¸€è§ˆ', icon: 'egg' },
            { title: 'BOSSè®¨ä¼æˆ˜', desc: 'ç„å†°ç™½è™æ— ä¼¤é€šå…³æ•™å­¦', icon: 'skull' },
            { title: 'å¿«é€Ÿèµšé’±', desc: 'å‰æœŸå¦‚ä½•é æ¬è¿å·¥æ—¥å…¥è¿‡ä¸‡', icon: 'coins' }
        ];

        const MARKER_TYPES = {
            'orb': { label: 'çµç ', icon: 'circle', class: 'icon-orb' },
            'chest': { label: 'å®ç®±', icon: 'box-open', class: 'icon-chest' },
            'teleport': { label: 'ä¼ é€ç‚¹', icon: 'dungeon', class: 'icon-teleport' },
            'user': { label: 'é‡å¤–boss', icon: 'location-dot', class: 'icon-user' }
        };

        const initialMapData = [
            {id: 'sys_t1', lat: 80, lng: 770, type: 'teleport', name: 'åˆå§‹ä¹‹åœ°', desc: 'ä¸–ç•Œçš„ä¸­å¿ƒï¼Œä¸€åˆ‡çš„èµ·æº'},
        ];

        // ================= é€»è¾‘ä¸­å¿ƒ =================
        let map;
        let layerGroups = {};
        let currentImageBase64 = "";

        // 1. åˆå§‹åŒ–
        window.addEventListener('load', () => {
            // å¼€åœºåŠ¨ç”»
            setTimeout(() => {
                const gate = document.getElementById('intro-gate');
                gate.style.opacity = '0';
                setTimeout(() => {
                    gate.style.display = 'none';
                    initParticles();
                }, 800);
            }, 1000); 
            
            // åˆå§‹åŒ–å„æ¨¡å—
            renderHome();
            renderDex();
            renderCraft();
            initBreed();
            initMap();
        });

        // 2. è§†å›¾åˆ‡æ¢
        function switchView(viewId, btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            if(viewId === 'map' && map) setTimeout(() => map.invalidateSize(), 200);
        }

        // 3. ä¸»é¡µæ¸²æŸ“
        function renderHome() {
            // æ¸²æŸ“æ–°é—»
            const newsBox = document.getElementById('news-container');
            let newsHtml = '';
            newsData.forEach(n => {
                const tagClass = n.type === 'update' ? 'tag-update' : (n.type === 'event' ? 'tag-event' : '');
                newsHtml += `
                    <div class="news-item">
                        <span class="news-tag ${tagClass}">${n.label}</span>
                        <span class="news-title">${n.title}</span>
                        <span class="news-date">${n.date}</span>
                    </div>
                `;
            });
            newsBox.innerHTML = newsHtml;

            // æ¸²æŸ“æ”»ç•¥
            const guideBox = document.getElementById('guide-container');
            let guideHtml = '';
            guideData.forEach(g => {
                guideHtml += `
                    <div class="guide-card">
                        <div class="guide-icon"><i class="fa-solid fa-${g.icon}"></i></div>
                        <div class="guide-info">
                            <h4>${g.title}</h4>
                            <p>${g.desc}</p>
                        </div>
                    </div>
                `;
            });
            guideBox.innerHTML = guideHtml;

            // æ¸²æŸ“ç»Ÿè®¡æ•°æ®
            document.getElementById('stat-count').innerText = spirits.length;
        }

        // 4. æ¸²æŸ“å›¾é‰´
        function renderDex() {
            const container = document.getElementById('dex-grid');
            const search = document.getElementById('dexSearch').value.toLowerCase();
            const filter = document.getElementById('dexFilter').value;
            container.innerHTML = '';

            let delay = 0;
            const elMap = { 'é‡‘':'el-metal','æœ¨':'el-wood','æ°´':'el-water','ç«':'el-fire','åœŸ':'el-earth','æ— ':'el-none','å¦–':'el-metal','é¾™':'el-water' };

            spirits.forEach(s => {
                if (filter !== 'all' && !s.el.includes(filter)) return;
                if (search && !JSON.stringify(s).toLowerCase().includes(search)) return;

                const tagsHtml = s.tags.map(t => `<span class="tag">${t}</span>`).join('');
                const elClass = elMap[s.el] || 'el-none';

                const card = document.createElement('div');
                card.className = 'spirit-card';
                card.style.animation = `slideIn 0.5s ease forwards ${delay}s`;
                card.style.opacity = '0';
                
                card.innerHTML = `
                    <div class="card-badge ${elClass}">${s.el}</div>
                    <div class="card-img-placeholder"><i class="fa-solid fa-dragon"></i></div>
                    <div class="card-content">
                        <div class="card-title">
                            ${s.name} 
                            <span class="card-id">NO.${s.id}</span>
                        </div>
                        <div class="card-desc">${s.desc}</div>
                        <div class="tag-group">${tagsHtml}</div>
                    </div>
                `;
                container.appendChild(card);
                delay += 0.05;
            });
        }

        // 5. æ¸²æŸ“é…æ–¹
        function renderCraft() {
            const container = document.getElementById('recipe-list');
            const search = document.getElementById('craftSearch').value.toLowerCase();
            container.innerHTML = '';
            
            let delay = 0;
            recipes.forEach(r => {
                if (search && !JSON.stringify(r).toLowerCase().includes(search)) return;
                
                const item = document.createElement('div');
                item.className = 'recipe-card';
                item.style.animationDelay = `${delay}s`;
                
                item.innerHTML = `
                    <div style="font-size:24px; color:var(--accent); margin-right:20px;"><i class="fa-solid fa-scroll"></i></div>
                    <div style="flex:1;">
                        <div style="font-size:18px; font-weight:bold; color:#333;">${r.name}</div>
                        <div style="font-size:13px; color:#888;">${r.type} | <i class="fa-solid fa-lock-open"></i> Lv.${r.lv}</div>
                    </div>
                    <div style="font-size:13px; color:#555; background:#f9f9f9; padding:8px 15px; border-radius:8px;">
                        ${r.mat}
                    </div>
                `;
                container.appendChild(item);
                delay += 0.05;
            });
        }

        // 6. é…ç§é€»è¾‘
        function initBreed() {
            const p1 = document.getElementById('p1');
            const p2 = document.getElementById('p2');
            spirits.forEach(s => {
                const opt = `<option value="${s.id}">${s.name}</option>`;
                p1.innerHTML += opt;
                p2.innerHTML += opt;
            });
        }
        function checkBreed() {
            const p1 = document.getElementById('p1').value;
            const p2 = document.getElementById('p2').value;
            const resName = document.getElementById('result-name');
            const resEgg = document.getElementById('result-egg');
            
            if(p1 !== 'é€‰æ‹©çˆ¶æœ¬' && p2 !== 'é€‰æ‹©æ¯æœ¬') {
                resName.innerText = "æ­£åœ¨æ¨æ¼”...";
                resEgg.style.animationDuration = "0.5s";
                setTimeout(() => {
                    resName.innerText = "æœªçŸ¥çµå…½ (å¾…å½•å…¥)"; 
                    resEgg.style.animationDuration = "3s";
                }, 800);
            }
        }

        // 7. åœ°å›¾é€»è¾‘ (Map & Modal)
        function initMap() {
            map = L.map('map-container', { 
                crs: L.CRS.Simple, minZoom: -2, maxZoom: 2,
                zoomControl: false, attributionControl: false
            });

            const bounds = [[0,0], [1000,1000]];
            // æ³¨æ„ï¼šè¿™é‡Œå¼•ç”¨äº†å¤–éƒ¨å›¾ç‰‡ 'å±±æµ·å¤§é™†åœ°å›¾.png'ã€‚
            // å¦‚æœæ‚¨æ²¡æœ‰è¯¥å›¾ç‰‡ï¼Œåœ°å›¾èƒŒæ™¯å°†æ˜¾ç¤ºä¸ºè“è‰² (#a0d2ef)ï¼Œè¿™æ˜¯æ­£å¸¸çš„å…œåº•æ˜¾ç¤ºã€‚
            L.imageOverlay('å±±æµ·å¤§é™†åœ°å›¾.png', bounds).addTo(map);
            map.fitBounds(bounds);

            Object.keys(MARKER_TYPES).forEach(k => layerGroups[k] = L.layerGroup().addTo(map));

            // åŠ è½½ç³»ç»Ÿé»˜è®¤ç‚¹
            initialMapData.forEach(d => renderMarker(d));
            // åŠ è½½ç”¨æˆ·ç‚¹
            loadUserMarkers();

            // ç‚¹å‡»åœ°å›¾ -> æ–°å»º
            map.on('click', function(e) {
                openModal({
                    lat: e.latlng.lat, lng: e.latlng.lng,
                    id: '', name: '', type: 'user', desc: '', img: ''
                });
            });
        }

        function renderMarker(data) {
            removeMarkerFromMap(data.id); // é¿å…é‡å¤

            const config = MARKER_TYPES[data.type] || MARKER_TYPES['user'];
            
            const icon = L.divIcon({
                html: `<i class="fa-solid fa-${config.icon}"></i>`,
                className: `icon-base ${config.class}`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            const marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(layerGroups[data.type]);
            marker.meta = data; 

            // Tooltip (æ‚¬æµ®æç¤º)
            marker.bindTooltip(`
                <div style="text-align:center">
                    <div style="font-weight:bold; margin-bottom:2px;">${data.name}</div>
                    <div style="font-size:10px; color:#ddd;">${config.label}</div>
                    ${data.img ? '<div style="font-size:9px; color:#ffd700; margin-top:2px;"><i class="fa-regular fa-image"></i> å«å›¾ç‰‡</div>' : ''}
                </div>
            `, {
                direction: 'top', className: 'custom-tooltip', offset: [0, -15], opacity: 1
            });

            // Click (ç‚¹å‡»æ¨¡æ€æ¡†)
            marker.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                openModal(data);
            });

            return marker;
        }

        function removeMarkerFromMap(id) {
            Object.values(layerGroups).forEach(group => {
                group.eachLayer(layer => {
                    if (layer.meta && layer.meta.id === id) group.removeLayer(layer);
                });
            });
        }

        // 8. æ¨¡æ€æ¡†äº¤äº’
        const modalOverlay = document.getElementById('marker-modal-overlay');
        const imgPreview = document.getElementById('marker-img-preview');
        const imgInput = document.getElementById('marker-img-input');

        function openModal(data) {
            document.getElementById('marker-id').value = data.id;
            document.getElementById('marker-lat').value = data.lat;
            document.getElementById('marker-lng').value = data.lng;
            document.getElementById('marker-name').value = data.name;
            document.getElementById('marker-type').value = data.type;
            document.getElementById('marker-desc').value = data.desc || '';
            
            currentImageBase64 = data.img || '';
            if (currentImageBase64) {
                imgPreview.src = currentImageBase64;
                imgPreview.style.display = 'block';
            } else {
                imgPreview.src = '';
                imgPreview.style.display = 'none';
            }
            imgInput.value = ''; 

            document.getElementById('btn-delete').style.display = data.id ? 'block' : 'none';
            document.querySelector('.modal-title').innerText = data.id ? 'ç¼–è¾‘åœ°ç‚¹è¯¦æƒ…' : 'æ·»åŠ æ–°å‘ç°';
            modalOverlay.classList.add('open');
        }

        function closeModal() {
            modalOverlay.classList.remove('open');
        }
        modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) closeModal(); });

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if(e.total > 500000) console.warn("å›¾ç‰‡è¾ƒå¤§ï¼Œå¯èƒ½å ç”¨å­˜å‚¨");
                    currentImageBase64 = e.target.result;
                    imgPreview.src = currentImageBase64;
                    imgPreview.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveMarkerData() {
            const id = document.getElementById('marker-id').value || 'u_' + Date.now();
            const lat = parseFloat(document.getElementById('marker-lat').value);
            const lng = parseFloat(document.getElementById('marker-lng').value);
            const name = document.getElementById('marker-name').value;
            const type = document.getElementById('marker-type').value;
            const desc = document.getElementById('marker-desc').value;

            if (!name) return alert("è¯·å¡«å†™åç§°ï¼");

            const markerData = { id, lat, lng, name, type, desc, img: currentImageBase64 };
            
            saveToStorage(markerData);
            renderMarker(markerData);
            closeModal();
        }

        function deleteCurrentMarker() {
            const id = document.getElementById('marker-id').value;
            if(!id || !confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ")) return;
            removeMarkerFromMap(id);
            removeFromStorage(id);
            closeModal();
        }

        // 9. æ•°æ®æŒä¹…åŒ–
        const STORAGE_KEY = 'shanhai_full_v3';
        function saveToStorage(data) {
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const idx = saved.findIndex(m => m.id === data.id);
            if (idx > -1) saved[idx] = data;
            else saved.push(data);
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(saved)); } catch (e) { alert("å­˜å‚¨æ»¡!"); }
        }
        function removeFromStorage(id) {
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            saved = saved.filter(m => m.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
        }
        function loadUserMarkers() {
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            saved.forEach(d => renderMarker(d));
        }

        function toggleLayer(type, btn) {
            if (map.hasLayer(layerGroups[type])) {
                map.removeLayer(layerGroups[type]);
                btn.classList.remove('active');
            } else {
                map.addLayer(layerGroups[type]);
                btn.classList.add('active');
            }
        }

        // 10. ç²’å­ç‰¹æ•ˆ
        function initParticles() {
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const p = Array.from({length:40}, () => ({
                x: Math.random()*canvas.width, y: Math.random()*canvas.height,
                r: Math.random()*2+1, d: Math.random()*0.5+0.1
            }));
            function draw(){
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle = "rgba(212,175,55,0.3)";
                ctx.beginPath();
                p.forEach(pt => {
                    ctx.moveTo(pt.x, pt.y); ctx.arc(pt.x, pt.y, pt.r, 0, Math.PI*2);
                    pt.y -= pt.d; if(pt.y<0) pt.y=canvas.height;
                });
                ctx.fill(); requestAnimationFrame(draw);
            }
            draw();
        }
    </script>
</body>
</html>